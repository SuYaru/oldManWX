<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Basic Layout - jQuery EasyUI Demo</title>
	<link rel="stylesheet" type="text/css" href="../css/themes/default/easyui.css">
	<link rel="stylesheet" type="text/css" href="../css/themes/icon.css">
	<script type="text/javascript" src="../js/jquery.min.js"></script>
    <script type="text/javascript" src="../js/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../js/jquery.serializejson.min.js"></script>
</head>
<body>
        <!-- <table id="dg"></table> -->
    <div class="easyui-layout" data-options="fit:true">
        <div data-options="region:'west',split:true" title="新闻分类" style="width:200px;">
                <ul id="tt"></ul>
        </div>
        <div data-options="region:'center',title:'新闻内容',iconCls:'icon-ok'">
            <table id="dg"></table>
                <div id="tb" style="padding:2px 5px;">
                    <input id="name" label="搜索内容:" style="width:30%;height:30px;margin:10px 0" placeholder="新闻标题">
                    <a href="#" id="searchData" class="easyui-linkbutton" iconCls="icon-search">搜索</a>
                    <a href="#" id="addData" class="easyui-linkbutton" data-options="iconCls:'icon-add'">新增</a>
                    <a href="#" id="removesData" class="easyui-linkbutton" data-options="iconCls:'icon-remove'">批量删除</a>
                </div>

                <div id="dlg" class="easyui-dialog" title="Basic Dialog" data-options="iconCls:'icon-save',closed: true" style="width:400px;padding:10px">
                    <form id="newsForm" class="easyui-form" method="post" data-options="novalidate:true">
                           <input   name="_id" style="width:100%" type="hidden">
                            <!--  <input   name="newsId" id="newsId" style="width:100%"> -->
                        <div style="margin-bottom:20px">
                            <input class="easyui-textbox" name="title" style="width:100%" data-options="label:'主题:',required:true">
                        </div>
                        <div style="margin-bottom:20px">
                            <input class="easyui-textbox"  name="content" style="width:100%" data-options="label:'内容:',required:true">
                        </div>
                        <div style="margin-bottom:20px">
                            <input class="easyui-textbox"  name="keyWords" style="width:100%" data-options="label:'关键词:',required:true">
                        </div>
                        <div style="margin-bottom:20px">
                            <input class="easyui-textbox"  name="author" style="width:100%" data-options="label:'撰稿人:',required:true">
                        </div>
                    </form>
                    <div style="text-align:center;padding:5px 0">
                        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="submitForm()" style="width:80px">提交</a>
                        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="clearForm()" style="width:80px">重置</a>
                    </div>
                </div>
        </div>
    </div>
</body>
</html>


<script>
    var gloableURL=window.parent.gloableURL;
    // 显示左侧树状结构
    var newsId = '';
    $('#tt').tree({
        url:`${gloableURL}cate/list/1`,
        onClick:function(node){
            $('#dg').datagrid({
                queryParams: {
                    newsId: node._id
                }
            });
            newsId=node._id;
        }
    });

 function submitForm(){
    $('#newsForm').form('submit',{
        onSubmit:function(){

           if($(this).form('enableValidation').form('validate')){
                var formData = $("#newsForm").serializeJSON();
                formData.newsId=newsId;
                console.log(formData._id);
                // 将当前页面的表单信息进行获取，然后进行ajax请求
                if(formData._id.length > 0){
                    // update
                    $.ajax({
                        url:`${gloableURL}news/${formData._id}`,
                        type:'put',
                        data: formData
                    }).done(function(res){
                        $('#dlg').dialog('close');
                        $('#dg').datagrid('reload');
                        $('#newsForm').form('clear');
                    })
                }else{
                    // add
                    delete formData._id;
                    $.ajax({
                        url:`${gloableURL}news`,
                        type:'post',
                        data: formData
                    }).done(function(res){
                        $('#dlg').dialog('close');
                        $('#dg').datagrid('reload');
                        $('#newsForm').form('clear');
                    })
                }
           }
        }
    });
    return false; // 阻止默认事件
}
function clearForm(){
    $('#newsForm').form('clear');
}


$('#dg').datagrid({
    url:`${gloableURL}news/list`,
    fit:'true',
    border:false,
    pagination:true,
    toolbar:'#tb',
    columns:[[
        {field:'ck',checkbox:true},
        {field:'title',title:'新闻标题',width:100},
        {field:'content',title:'新闻内容',width:200},
        {field:'keyWords',title:'关键词',width:100},
        {field:'author',title:'撰稿人',width:100},
        {field:'_id',title:'操作', width:80,
            formatter: function(value,row,index){
				return `<a href="javascript:void(0)" onclick="updateData('${row._id}',this)">修改</a> <a href="javascript:void(0)" onclick="deleteData('${row._id}')">删除</a>`
			}
		}
    ]]
});

function deleteData(id){
    $.messager.confirm('确认对话框', '你确认删除?', function(r){
        if (r){

            $.ajax({
                url:`${gloableURL}news/${id}`,
                type:'delete'
            }).done(function(res){
                $("#dg").datagrid('reload');
            })
        }
    });

}

function updateData(id,target){
    $(target).parents('.datagrid-row').siblings().
    removeClass('datagrid-row-over datagrid-row-checked datagrid-row-selected');

    $.ajax({
        url:`${gloableURL}news/${id}`,
        type:'get'
    }).done(function(res){
        $('#newsForm').form('load',res);
        $('#dlg').dialog('open');
    })

}

function deleteDatas(){
    var rows = $('#dg').datagrid('getSelections');
    var ids = [];
    for(var i=0;i<rows.length;i++){
        ids.push(rows[i]._id);
    }

    $.messager.confirm('确认对话框', '你确认删除?', function(r){
        if (r){
            $.ajax({
                url:`${gloableURL}news/removes`,
                type:'post',
                data:{
                    ids: ids.toString()
                }
            }).done(function(res){
                $.messager.confirm('提示', '所选数据已被删除');
                $("#dg").datagrid('reload');
            })
        }
    });
}

$("#searchData").click(function(){
    $('#dg').datagrid({
        queryParams: {
            name: $("#name").val()
        }
    });
    $("#searchFor").val("");
})


$("#addData").click(function(){
    console.log(newsId);
    if(newsId){
        $('.validatebox-text').each(function(index,value){
            //console.log($('#userform'));
            //console.log ($(value));
            $(this).removeClass('validatebox-invalid');
            $(this).parent('.easyui-fluid').removeClass('textbox-invalid');
        })
        $('#dlg').dialog('open');
    }else{
        $.messager.confirm('提示','请选择一个添加子类');
    }

})

$("#removesData").click(function(){
    deleteDatas();
})
</script>