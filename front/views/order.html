<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Basic Layout - jQuery EasyUI Demo</title>
	<link rel="stylesheet" type="text/css" href="../css/themes/default/easyui.css">
	<link rel="stylesheet" type="text/css" href="../css/themes/icon.css">
	<script type="text/javascript" src="../js/jquery.min.js"></script>
    <script type="text/javascript" src="../js/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../js/jquery.serializejson.min.js"></script>
</head>
<body>
        <!-- <table id="dg"></table> -->
    <div class="easyui-layout" data-options="fit:true">
        <div data-options="region:'west',split:true" title="订单类别" style="width:200px;">
                <ul id="tt"></ul>
        </div>
        <div data-options="region:'center',title:'订单详情',iconCls:'icon-ok'">
            <table id="dg"></table>
                <div id="tb" style="padding:2px 5px;">
                    <input id="name" label="搜索订单:" style="width:30%;height:30px;margin:10px 0" placeholder="订单名称">
                    <a href="#" id="searchData" class="easyui-linkbutton" iconCls="icon-search">搜索</a>
                    <a href="#" id="addData" class="easyui-linkbutton" data-options="iconCls:'icon-add'">新增</a>
                    <a href="#" id="removesData" class="easyui-linkbutton" data-options="iconCls:'icon-remove'">批量删除</a>
                </div>

                <div id="dlg" class="easyui-dialog" title="Basic Dialog" data-options="iconCls:'icon-save',closed: true" style="width:400px;padding:10px">
                    <form id="orderForm" class="easyui-form" method="post" data-options="novalidate:true">
                           <input   name="_id" style="width:100%" type="hidden">
                            <!--  <input   name="newsId" id="newsId" style="width:100%"> -->
                        <div style="margin-bottom:20px">
                            <input class="easyui-textbox" name="ordername" style="width:100%" data-options="label:'订单名称:',required:true">
                        </div>
                        <div style="margin-bottom:20px">
                            <input class="easyui-textbox"  name="details" style="width:100%" data-options="label:'订单明细:',required:true">
                        </div>
                        <div style="margin-bottom:20px">
                            <input class="easyui-textbox"  name="sdate" style="width:100%" data-options="label:'开始时间:',required:true">
                        </div>
                        <div style="margin-bottom:20px">
                            <input class="easyui-textbox"  name="fdate" style="width:100%" data-options="label:'预计时间:',required:true">
                        </div>
                        <div style="margin-bottom:20px;">
                            订单进度:
                            <div style="margin-left:70px">

                            <input class="easyui-slider" value="12" style="width:240px" data-options="
			showTip: true,
			rule: [0,'|',25,'|',50,'|',75,'|',100],
			tipFormatter: function(value){
				return value+'%';
            }">
        </div>
                        </div>
                    </form>
                    <div style="text-align:center;padding:5px 0">
                        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="submitForm()" style="width:80px">提交</a>
                        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="clearForm()" style="width:80px">重置</a>
                    </div>
                </div>
        </div>
    </div>
</body>
</html>


<script>
    var gloableURL=window.parent.gloableURL;
    // 显示左侧树状结构
    var orderId = '';
    $('#tt').tree({
        url:`${gloableURL}cate/list/2`,
        onClick:function(node){
            $('#dg').datagrid({
                queryParams: {
                    orderId: node._id
                }
            });
            orderId=node._id;
        }
    });

 function submitForm(){
    $('#orderForm').form('submit',{
        onSubmit:function(){

           if($(this).form('enableValidation').form('validate')){
                var formData = $("#orderForm").serializeJSON();
                formData.orderId=orderId;
                console.log(formData._id);
                // 将当前页面的表单信息进行获取，然后进行ajax请求
                if(formData._id.length > 0){
                    // update
                    $.ajax({
                        url:`${gloableURL}order/${formData._id}`,
                        type:'put',
                        data: formData
                    }).done(function(res){
                        $('#dlg').dialog('close');
                        $('#dg').datagrid('reload');
                        $('#orderForm').form('clear');
                    })
                }else{
                    // add
                    delete formData._id;
                    $.ajax({
                        url:`${gloableURL}order`,
                        type:'post',
                        data: formData
                    }).done(function(res){
                        $('#dlg').dialog('close');
                        $('#dg').datagrid('reload');
                        $('#orderForm').form('clear');
                    })
                }
           }
        }
    });
    return false; // 阻止默认事件
}
function clearForm(){
    $('#orderForm').form('clear');
}


$('#dg').datagrid({
    url:`${gloableURL}order/list`,
    fit:'true',
    border:false,
    pagination:true,
    toolbar:'#tb',
    columns:[[
        {field:'ck',checkbox:true},
        {field:'ordername',title:'订单名称',width:100},
        {field:'details',title:'订单明细',width:200},
        {field:'sdate',title:'开始时间',width:100},
        {field:'fdate',title:'预计完成时间',width:100},
        {field:'progress',title:'订单进度',width:100},
        {field:'_id',title:'操作', width:80,
            formatter: function(value,row,index){
				return `<a class="edit-a" href="javascript:void(0)" onclick="updateData('${row._id}',this)" style="display:inline-block;width:25px;height:25px;float:left;"></a> <a class="delete-a" href="javascript:void(0)" onclick="deleteData('${row._id}')" style="display:inline-block;width:25px;height:25px;float:right;"></a>`
			}
		}
    ]]
});

function deleteData(id){
    $.messager.confirm('确认对话框', '你确认删除吗?', function(r){
        if (r){

            $.ajax({
                url:`${gloableURL}order/${id}`,
                type:'delete'
            }).done(function(res){
                $("#dg").datagrid('reload');
            })
        }
    });

}

function updateData(id,target){
    $(target).parents('.datagrid-row').siblings().
    removeClass('datagrid-row-over datagrid-row-checked datagrid-row-selected');

    $.ajax({
        url:`${gloableURL}order/${id}`,
        type:'get'
    }).done(function(res){
        $('#orderForm').form('load',res);
        $('#dlg').dialog('open');
    })

}

function deleteDatas(){
    var rows = $('#dg').datagrid('getSelections');
    var ids = [];
    for(var i=0;i<rows.length;i++){
        ids.push(rows[i]._id);
    }

    $.messager.confirm('确认对话框', '你确认删除?', function(r){
        if (r){
            $.ajax({
                url:`${gloableURL}order/removes`,
                type:'post',
                data:{
                    ids: ids.toString()
                }
            }).done(function(res){
                $.messager.confirm('提示', '所选数据已被删除');
                $("#dg").datagrid('reload');
            })
        }
    });
}

$("#searchData").click(function(){
    $('#dg').datagrid({
        queryParams: {
            ordername: $("#ordername").val()
        }
    });
    $("#searchFor").val("");
})


$("#addData").click(function(){
    console.log(orderId);
    if(orderId){
        $('.validatebox-text').each(function(index,value){
            //console.log($('#userform'));
            //console.log ($(value));
            $(this).removeClass('validatebox-invalid');
            $(this).parent('.easyui-fluid').removeClass('textbox-invalid');
        })
        $('#dlg').dialog('open');
    }else{
        $.messager.confirm('提示','请选择一个添加子类');
    }

})

$("#removesData").click(function(){
    deleteDatas();
})
</script>